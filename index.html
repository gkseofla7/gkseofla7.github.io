<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My 3D Portfolio (Daerim)</title>
    <style>
        body { margin: 0; background-color: #050505; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* ★ [추가됨] 상단 제목 스타일 */
        .header-container {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
            pointer-events: none; /* 마우스 이벤트를 통과시켜서 뒤쪽 3D 컨트롤 가능하게 함 */
            width: 100%;
        }

        .header-container h1 {
            font-size: 3rem;
            margin: 0;
            font-weight: 800;
            letter-spacing: 5px;
            color: #ffffff;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); /* 은은한 빛 효과 */
        }

        .header-container p {
            font-size: 1.1rem;
            color: #aaaaaa;
            margin-top: 10px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        /* 하단 링크 버튼 */
        .links-container {
            position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; z-index: 10; pointer-events: auto;
        }
        .link-btn {
            text-decoration: none; color: white; border: 1px solid rgba(255,255,255,0.5);
            padding: 12px 30px; font-size: 14px; font-weight: bold;
            background-color: rgba(0, 0, 0, 0.3); transition: all 0.3s ease; white-space: nowrap;
            backdrop-filter: blur(5px); /* 블러 효과 */
            border-radius: 30px;
        }
        .link-btn:hover { background-color: white; color: black; border-color: white; }

        /* 말풍선 스타일 */
        .speech-bubble {
            position: relative;
            background: #333333; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: .4em;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 16px;
            color: #ffffff; 
            box-shadow: 0px 4px 15px rgba(0,0,0,0.5); 
            opacity: 0; 
            transition: opacity 0.5s;
            cursor: pointer;
            pointer-events: auto;
            white-space: nowrap;
            text-align: center;
            user-select: none;
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: #333333; 
            border-bottom: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div class="header-container">
        <h1>PORTFOLIO</h1>
    </div>

    <div id="canvas-container"></div>

    <div id="portfolio-label" class="speech-bubble">Touch Me</div>

    <div class="links-container">
        <a href="https://github.com/gkseofla7" class="link-btn" target="_blank">GITHUB</a>
        <a href="https://www.linkedin.com/in/%EB%8C%80%EB%A6%BC-%ED%95%9C-299aab293/" class="link-btn" target="_blank">LINKEDIN</a>
        <a href="#" class="link-btn" target="_blank">POSTS</a>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        let scene, camera, renderer, labelRenderer, controls, clock;
        let mixer, actions = [], activeAction, defaultAction;
        let characterGroup, modelContainer, hipsBone;
        let lastHipsPosition = new THREE.Vector3();
        let isTransitioning = false;
        let bubbleLabel; 

        init();
        animate();

        function init() {
            initScene();
            setupLights();
            loadEnvironment();
            loadCharacter();
            setupEvents();
        }

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color('#050505'); 
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 4);

            // 1. WebGL Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 2. CSS2D Renderer (말풍선용)
            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none';
            document.body.appendChild(labelRenderer.domElement);

            // 컨트롤 대상을 3D 캔버스로 설정
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.05;
            controls.target.set(0, 1, 0);  
            
            controls.maxPolarAngle = Math.PI / 2 - 0.05; // 바닥 뚫기 방지
            controls.minDistance = 2; 
            controls.maxDistance = 10; 

            clock = new THREE.Clock();
            characterGroup = new THREE.Group();
            modelContainer = new THREE.Group();
            scene.add(characterGroup);
            characterGroup.add(modelContainer);
        }

        function setupLights() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(2, 5, 2);
            dirLight.castShadow = true;
            scene.add(dirLight);
        }

        function loadEnvironment() {
            new RGBELoader().load('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/moonlit_golf_1k.hdr', function (texture) {
                texture.mapping = THREE.EquirectangularReflectionMapping;
                scene.environment = texture;
            });
        }

        function loadCharacter() {
            const loader = new GLTFLoader();

            loader.load('assets/ETAnim.glb', function (gltf) {
                const model = gltf.scene;
                setupModelMesh(model);
                
                modelContainer.add(model);
                mixer = new THREE.AnimationMixer(model);
                mixer.addEventListener('finished', restoreDefaultAnimation);

                processAnimations(gltf.animations);

                if (actions.length > 0) {
                    defaultAction = actions[0];
                    activeAction = defaultAction;
                    activeAction.play();
                }

                // 말풍선 부착
                const speechBubbleDiv = document.getElementById('portfolio-label');
                speechBubbleDiv.style.opacity = '1';
                
                bubbleLabel = new CSS2DObject(speechBubbleDiv);
                bubbleLabel.position.set(0, 0, 0);
                modelContainer.add(bubbleLabel);

                loader.load('assets/Greeting.glb', function (subGltf) {
                    processAnimations(subGltf.animations);
                    configureSubAnimations();
                    if (hipsBone) lastHipsPosition.copy(hipsBone.position);
                });
            }, undefined, (e) => console.error(e));
        }

        function setupModelMesh(model) {
            model.traverse(function (node) {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                }
                if (node.isBone && !hipsBone && 
                   (node.name.includes('Hips') || node.name.includes('Root') || node.name.includes('mixamorigHips'))) {
                    hipsBone = node;
                }
            });
        }

        function processAnimations(clips) {
            if (!clips || clips.length === 0) return;
            clips.forEach((clip) => {
                actions.push(mixer.clipAction(clip));
            });
        }

        function configureSubAnimations() {
            for (let i = 1; i < actions.length; i++) {
                actions[i].loop = THREE.LoopOnce;
                actions[i].clampWhenFinished = true;
            }
        }

        function setupEvents() {
            window.addEventListener('pointerdown', triggerAction);
            window.addEventListener('resize', onWindowResize, false);
        }

        function triggerAction() {
            if (!actions || actions.length <= 1 || isTransitioning || activeAction !== defaultAction) return;
            
            const label = document.getElementById('portfolio-label');
            if (label) label.innerText = "Hi! My Name Is Daerim";

            executeTransition(defaultAction, actions[1]);
        }

        function restoreDefaultAnimation(event) {
            if (event.action !== defaultAction) {
                const label = document.getElementById('portfolio-label');
                if (label) label.innerText = "Touch Me";

                executeTransition(event.action, defaultAction);
            }
        }

        function executeTransition(prev, next) {
            next.reset();
            next.play();
            prev.crossFadeTo(next, 1.0, true);
            isTransitioning = true;
            activeAction = next;
            setTimeout(() => { isTransitioning = false; }, 1000);
        }

        function updateRootMotion() {
            if (!hipsBone) return;

            const currentPos = hipsBone.position.clone();
            const deltaVec = new THREE.Vector3().subVectors(currentPos, lastHipsPosition);
            const scaledDelta = deltaVec.multiplyScalar(0.01);

            modelContainer.position.sub(scaledDelta);

            if (!isTransitioning && activeAction === defaultAction) {
                characterGroup.position.add(scaledDelta);
            }

            if (bubbleLabel) {
                bubbleLabel.position.copy(currentPos).multiplyScalar(0.01);
                bubbleLabel.position.y += 1.0; 
            }

            lastHipsPosition.copy(currentPos);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (mixer) {
                mixer.update(delta);
                updateRootMotion();
            }

            controls.update();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
    </script>
</body>
</html>