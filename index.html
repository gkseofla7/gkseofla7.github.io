<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My 3D Portfolio (Three.js)</title>
    <style>
        body { margin: 0; background-color: #0a0a0a; color: white; font-family: sans-serif; overflow: hidden; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        .links-container {
            position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; z-index: 10;
        }
        .link-btn {
            text-decoration: none; color: white; border: 2px solid white;
            padding: 12px 24px; font-size: 16px; font-weight: bold;
            background-color: rgba(0, 0, 0, 0.5); transition: all 0.3s ease; white-space: nowrap;
        }
        .link-btn:hover { background-color: white; color: black; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="links-container">
        <a href="https://github.com/gkseofla7" class="link-btn" target="_blank">Github</a>
        <a href="https://www.linkedin.com/in/%EB%8C%80%EB%A6%BC-%ED%95%9C-299aab293/" class="link-btn" target="_blank">LinkedIn</a>
        <a href="#" class="link-btn" target="_blank">Itch</a>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        let scene, camera, renderer, controls, clock;
        let mixer, actions = [], activeAction, defaultAction;
        let characterGroup, modelContainer, hipsBone;
        let lastHipsPosition = new THREE.Vector3();
        let isTransitioning = false;

        init();
        animate();

        function init() {
            initScene();
            setupLights();
            loadEnvironment();
            loadCharacter();
            setupEvents();
        }

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color('#0a0a0a');

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 4);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 1, 0);

            clock = new THREE.Clock();

            characterGroup = new THREE.Group();
            modelContainer = new THREE.Group();
            scene.add(characterGroup);
            characterGroup.add(modelContainer);
        }

        function setupLights() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(2, 5, 2);
            dirLight.castShadow = true;
            scene.add(dirLight);
        }

        function loadEnvironment() {
            new RGBELoader()
                .load('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/moonlit_golf_1k.hdr', function (texture) {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    scene.environment = texture;
                });
        }

        function loadCharacter() {
            const loader = new GLTFLoader();

            loader.load('assets/ETAnim.glb', function (gltf) {
                const model = gltf.scene;
                setupModelMesh(model);
                
                modelContainer.add(model);
                mixer = new THREE.AnimationMixer(model);
                mixer.addEventListener('finished', restoreDefaultAnimation);

                processAnimations(gltf.animations);

                if (actions.length > 0) {
                    defaultAction = actions[0];
                    activeAction = defaultAction;
                    activeAction.play();
                }

                loader.load('assets/Greeting.glb', function (subGltf) {
                    processAnimations(subGltf.animations);
                    configureSubAnimations();
                    if (hipsBone) lastHipsPosition.copy(hipsBone.position);
                });
            }, undefined, (e) => console.error(e));
        }

        function setupModelMesh(model) {
            model.traverse(function (node) {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                }
                if (node.isBone && !hipsBone && 
                   (node.name.includes('Hips') || node.name.includes('Root') || node.name.includes('mixamorigHips'))) {
                    hipsBone = node;
                }
            });
        }

        function processAnimations(clips) {
            if (!clips || clips.length === 0) return;
            clips.forEach((clip) => {
                const action = mixer.clipAction(clip);
                actions.push(action);
            });
        }

        function configureSubAnimations() {
            for (let i = 1; i < actions.length; i++) {
                const action = actions[i];
                action.loop = THREE.LoopOnce;
                action.clampWhenFinished = true;
            }
        }

        function setupEvents() {
            window.addEventListener('pointerdown', triggerAction);
            window.addEventListener('resize', onWindowResize, false);
        }

        function triggerAction() {
            if (!actions || actions.length <= 1 || isTransitioning || activeAction !== defaultAction) return;
            executeTransition(defaultAction, actions[1]);
        }

        function restoreDefaultAnimation(event) {
            if (event.action !== defaultAction) {
                executeTransition(event.action, defaultAction);
            }
        }

        function executeTransition(prev, next) {
            next.reset();
            next.play();
            prev.crossFadeTo(next, 1.0, true);

            isTransitioning = true;
            activeAction = next;
            
            setTimeout(() => {
                isTransitioning = false;
            }, 1000);
        }

        function updateRootMotion() {
            if (!hipsBone) return;

            const currentPos = hipsBone.position.clone();
            const deltaVec = new THREE.Vector3().subVectors(currentPos, lastHipsPosition);
            const scaledDelta = deltaVec.multiplyScalar(0.01);

            modelContainer.position.sub(scaledDelta);

            if (!isTransitioning && activeAction === defaultAction) {
                characterGroup.position.add(scaledDelta);
            }

            lastHipsPosition.copy(currentPos);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (mixer) {
                mixer.update(delta);
                updateRootMotion();
            }

            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>